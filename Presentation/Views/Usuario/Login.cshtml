@model Application.DTOs.Usuarios.Request.LoginDto
@{
    ViewData["Title"] = "Iniciar SesiÃ³n";
    Layout = "_AuthLayout";
    var domain = ViewData["Domain"] as string;
    var emailDomain = ViewData["EmailDomain"] as string;
}

<form asp-action="Login" method="post" class="mt-0" id="loginForm">
    @Html.AntiForgeryToken()

    <div class="mb-4">
        <h4 class="fw-semibold mb-1">Inicia sesiÃ³n</h4>
        <p class="text-muted small mb-0">Accede a tu cuenta de Biblioteca Universitaria.</p>
    </div>

    <div class="mb-3">
        <label for="Usuario" class="form-label small text-muted text-uppercase fw-semibold">Correo Institucional</label>
        <div class="input-group has-validation">
            <span class="input-group-text bg-transparent border-end-0">
                <i class="fas fa-envelope text-muted"></i>
            </span>
            <input type="text"
                   class="form-control border-start-0"
                   id="Usuario"
                   name="Correo"
                   placeholder="ejemplo: correo2020"
                   autocomplete="username"
                   required
                   maxlength="100"
                   title="Ingresa solo el nombre de usuario (ej: luedardo.rondon)">
            <span class="input-group-text bg-transparent border-start-0 text-muted user-select-none" id="domainSuffix">@emailDomain</span>
            
            <!-- Campo oculto para enviar el correo completo al servidor -->
            <input type="hidden" id="Correo" name="Correo" value="">
            
            <div id="usuarioFeedback" class="invalid-feedback">
                Por favor ingresa tu nombre de usuario institucional
            </div>
        </div>
        <span class="form-text small text-muted">Ingresa solo tu nombre de usuario institucional (sin @emailDomain)</span>
    </div>
    
    <div class="mb-3">
        <label for="Contrasena" class="form-label small text-muted text-uppercase fw-semibold">ContraseÃ±a</label>
        <div class="input-group">
            <span class="input-group-text bg-transparent border-end-0">
                <i class="fas fa-lock text-muted"></i>
            </span>
            <input type="password" 
                   class="form-control border-start-0" 
                   id="Contrasena" 
                   name="Contrasena" 
                   placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                   autocomplete="current-password"
                   required>
            <button class="btn btn-outline-secondary border-start-0" type="button" id="togglePassword">
                <i class="fas fa-eye"></i>
            </button>
        </div>
    </div>
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check mb-0">
            <input type="checkbox" class="form-check-input" id="RememberMe" name="RememberMe">
            <label class="form-check-label small" for="RememberMe">Recordar sesiÃ³n</label>
        </div>
        <a href="/usuario/recuperacion" class="login-link small">Â¿Olvidaste tu contraseÃ±a?</a>
    </div>
    
    <button type="submit" class="btn btn-primary w-100 py-2 mb-3">
        <i class="fas fa-arrow-right-to-bracket me-2"></i> Entrar
    </button>
    
    <div class="text-center">
        <p class="text-muted mb-2">Â¿Eres nuevo en la biblioteca?</p>
        <a asp-controller="Registro" asp-action="crear" class="btn btn-outline-primary w-100">
            <i class="fas fa-user-plus me-2"></i> Registrarse
        </a>
    </div>
</form>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const domainElement = document.getElementById('domainSuffix');
            const DOMAIN = domainElement ? domainElement.textContent.trim() : @ViewData["Domain"];
            console.log("Dominio detectado:", DOMAIN);

            const usuarioInput = document.getElementById('Usuario');
            const correoHiddenInput = document.getElementById('Correo');
            const contrasenaInput = document.getElementById('Contrasena');
            const togglePasswordBtn = document.getElementById('togglePassword');
            const loginForm = document.getElementById('loginForm');
            const usuarioFeedback = document.getElementById('usuarioFeedback');

             // Verificar que los elementos existen
            if (!usuarioInput) {
                console.error("âŒ No se encontrÃ³ el elemento #Usuario");
                return;
            }
            if (!correoHiddenInput) {
                console.error("âŒ No se encontrÃ³ el elemento #Correo (hidden)");
                return;
            }

    usuarioInput.addEventListener('input', function(e) {
            if (this.value.includes(@ViewData["Arroba"])) {
                this.value = this.value.replace(/@ViewData["Arroba"]/g, '');

            
            // Mostrar advertencia visual
            this.classList.add('is-invalid');
            usuarioFeedback.textContent = 'No debe incluir el sÃ­mbolo en el nombre de usuario';
            usuarioFeedback.style.display = 'block';
            
            // Ocultar la advertencia despuÃ©s de 2 segundos
            setTimeout(() => {
                this.classList.remove('is-invalid');
                usuarioFeedback.style.display = 'none';
            }, 2000);
        }
    });

    usuarioInput.addEventListener('paste', function(e) {
        // Obtener el texto pegado
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            if (pastedText.includes(@ViewData["Arroba"])) {
            e.preventDefault();
            
            // Mostrar advertencia
            this.classList.add('is-invalid');
                usuarioFeedback.textContent = 'No se puede pegar texto que contenga @ViewData["Arroba"]';
            usuarioFeedback.style.display = 'block';
            
            // Ocultar la advertencia despuÃ©s de 2 segundos
            setTimeout(() => {
                this.classList.remove('is-invalid');
                usuarioFeedback.style.display = 'none';
            }, 2000);
                 const withoutAt = pastedText.split(@ViewData["Arroba"])[0];
            if (withoutAt && withoutAt.trim() !== '') {
                document.execCommand('insertText', false, withoutAt);
            }
        }
    });

        // 3. Manejar el envÃ­o del formulario - construir el correo completo
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Obtener el valor del usuario (sin espacios al inicio/final)
        const username = usuarioInput.value.trim();
        
        // Validar que no estÃ© vacÃ­o
        if (!username) {
            usuarioInput.classList.add('is-invalid');
            usuarioFeedback.textContent = 'Por favor ingresa tu nombre de usuario institucional';
            usuarioFeedback.style.display = 'block';
            usuarioInput.focus();
            return;
        }
                if (username.includes(@ViewData["Arroba"])) {
            usuarioInput.classList.add('is-invalid');
                usuarioFeedback.textContent = 'El nombre de usuario no debe contener @ViewData["Arroba"]';
            usuarioFeedback.style.display = 'block';
            usuarioInput.focus();
            return;
        }
        
        // Construir el correo electrÃ³nico completo
        const emailCompleto = username + DOMAIN;
        
        // Asignar al campo oculto
        correoHiddenInput.value = emailCompleto;
        
        // Para depuraciÃ³n: mostrar en consola
        console.log("ðŸ“§ Correo completo enviado:", emailCompleto);
        
        // Opcional: tambiÃ©n puedes mostrar el correo completo en el campo visible (solo para visualizaciÃ³n)
        // usuarioInput.value = emailCompleto;
        
        // Enviar el formulario
        this.submit();
    });

    // 4. FunciÃ³n para mostrar/ocultar contraseÃ±a
    if (togglePasswordBtn) {
        togglePasswordBtn.addEventListener('click', function() {
            const type = contrasenaInput.getAttribute('type') === 'password' ? 'text' : 'password';
            contrasenaInput.setAttribute('type', type);
            
            // Cambiar el icono
            const icon = this.querySelector('i');
            if (type === 'text') {
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
    }

    // 5. ValidaciÃ³n en tiempo real mientras el usuario escribe
    usuarioInput.addEventListener('keyup', function() {
        const username = this.value.trim();
            if (username.includes(@ViewData["Arroba"])) {
            this.classList.add('is-invalid');
                usuarioFeedback.textContent = 'No debe incluir @ViewData["Arroba"] en el nombre de usuario';
            usuarioFeedback.style.display = 'block';
        } else if (username.length > 0) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
            usuarioFeedback.style.display = 'none';
            
            // Quitar la clase "is-valid" despuÃ©s de 2 segundos
            setTimeout(() => {
                this.classList.remove('is-valid');
            }, 2000);
        } else {
            this.classList.remove('is-invalid', 'is-valid');
            usuarioFeedback.style.display = 'none';
        }
    });

    // 6. Limpiar validaciÃ³n al enfocar el campo
    usuarioInput.addEventListener('focus', function() {
        this.classList.remove('is-invalid', 'is-valid');
        usuarioFeedback.style.display = 'none';
    });
        }
    </script>
}